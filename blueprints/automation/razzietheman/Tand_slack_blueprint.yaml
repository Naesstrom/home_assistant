blueprint:
  name: Rörelsestyrd Belysning med Circadian Lampor – Failsafe Pro 6.18.3
  description: 'En komplett automation för ditt smarta hem som kombinerar rörelsestyrning
    med avancerade failsafe-funktioner  och dynamiskt circadian-ljus. Huvudlampor,
    dag- och nattlampor, samt circual lights hanteras automatiskt –  ljus släcks efter
    inställd tid, dag- och nattscener återställs, och circadian-ljus anpassas efter
    solens höjd.  Allt loggas för full spårbarhet. Enkel att konfigurera, flexibel
    och säker för daglig drift.

    '
  domain: automation
  input:
    logging:
      name: Loggning
      description: Inställningar för loggning och notifieringar
      collapsed: true
      icon: mdi:note-text-outline
      input:
        use_persistent_notifications:
          name: Använd notifieringar istället för loggboken
          description: Om aktiverad skickas loggar som notiser istället för att skrivas
            i loggboken.
          default: false
          selector:
            boolean: {}
    sensors_switches:
      name: Sensorer & Brytare
      description: Välj rörelsesensorer och valfria smarta uttag
      collapsed: true
      icon: mdi:motion-sensor
      input:
        motion_sensors:
          name: Rörelsesensor(er)
          description: En eller flera rörelsesensorer som ska styra belysningen.
          default: []
          selector:
            entity:
              domain:
              - binary_sensor
              multiple: true
              reorder: false
        optional_switches:
          name: Smarta uttag eller strömbrytare
          description: Valfria smarta uttag eller strömbrytare som kan styra lamporna/enheterna.
          default: []
          selector:
            entity:
              domain:
              - switch
              multiple: true
              reorder: false
    head_lighting:
      name: Huvudlampor
      description: Inställningar för huvudlampor
      collapsed: true
      icon: mdi:lightbulb-on-outline
      input:
        main_lights:
          name: Huvudlampor
          description: Lampor som alltid ska tändas vid rörelse (oavsett dag/natt).
          default: []
          selector:
            target:
              entity:
              - domain:
                - light
        auto_off_main:
          name: Huvudlampors varaktighet (minuter)
          description: Hur länge huvudlamporna ska lysa efter senaste rörelse.
          default: []
          selector:
            number:
              min: 0.0
              max: 1200.0
              step: 1.0
              unit_of_measurement: min
              mode: box
    day_lighting:
      name: Dagbelysning
      description: Inställningar för daglampor och dagscener
      collapsed: true
      icon: mdi:weather-sunny
      input:
        scene_day:
          name: Dagscen
          description: Scen som aktiveras under dagtid (om vald).
          default: []
          selector:
            entity:
              domain:
              - scene
              multiple: false
              reorder: false
        off_scene_day:
          name: Off Scene Dag
          description: Scen som aktiveras när daglamporna ska stängas av.
          default: []
          selector:
            entity:
              domain:
              - scene
              multiple: false
              reorder: false
        day_lights:
          name: Dagslampor
          description: Lampor som bara ska tändas under dagtid.
          default: []
          selector:
            target:
              entity:
              - domain:
                - light
        auto_off_day:
          name: Daglampors varaktighet (minuter)
          default: []
          selector:
            number:
              min: 0.0
              max: 1200.0
              step: 1.0
              unit_of_measurement: min
              mode: box
        brightness_day:
          name: Dagsljusstyrka
          description: Valfri ljusstyrka för daglampor (0–100%).
          default: []
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 1.0
              unit_of_measurement: '%'
              mode: slider
        day_start:
          name: Dagsstart
          description: Tidpunkt då dagsläget aktiveras.
          default: 07:00:00
          selector:
            time: {}
        day_end:
          name: Dagslut
          description: Tidpunkt då dagsläget avaktiveras. Dagslut kan inte ha samma
            starttid som Nattstart.
          default: '21:59:59'
          selector:
            time: {}
        active_weekdays_day:
          name: Aktiva veckodagar (Dag)
          description: Välj vilka dagar dagsläget ska vara aktivt.
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Måndag
                value: mon
              - label: Tisdag
                value: tue
              - label: Onsdag
                value: wed
              - label: Torsdag
                value: thu
              - label: Fredag
                value: fri
              - label: Lördag
                value: sat
              - label: Söndag
                value: sun
              sort: false
              custom_value: false
    night_lighting:
      name: Nattbelysning
      description: Inställningar för nattlampor och nattscener
      collapsed: true
      icon: mdi:weather-night
      input:
        scene_night:
          name: Nattscen
          description: Scen som aktiveras under nattetid (om vald).
          default: []
          selector:
            entity:
              domain:
              - scene
              multiple: false
              reorder: false
        off_scene_night:
          name: Off Scene Natt
          description: Scen som aktiveras när nattlamporna ska stängas av.
          default: []
          selector:
            entity:
              domain:
              - scene
              multiple: false
              reorder: false
        night_lights:
          name: Nattlampor
          description: Lampor som bara ska tändas under nattetid.
          default: []
          selector:
            target:
              entity:
              - domain:
                - light
        auto_off_night:
          name: Nattlampors varaktighet (minuter)
          default: []
          selector:
            number:
              min: 0.0
              max: 1200.0
              step: 1.0
              unit_of_measurement: min
              mode: box
        brightness_night:
          name: Nattljusstyrka
          default: []
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 1.0
              unit_of_measurement: '%'
              mode: slider
        night_start:
          name: Nattstart
          default: '22:00:00'
          selector:
            time: {}
        night_end:
          name: Nattslut
          default: 06:59:59
          selector:
            time: {}
        active_weekdays_night:
          name: Aktiva veckodagar (Natt)
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Måndag
                value: mon
              - label: Tisdag
                value: tue
              - label: Onsdag
                value: wed
              - label: Torsdag
                value: thu
              - label: Fredag
                value: fri
              - label: Lördag
                value: sat
              - label: Söndag
                value: sun
              sort: false
              custom_value: false
    restore_scenes:
      name: Scenhantering
      description: Hantera och återställ scener automatiskt.
      collapsed: true
      icon: mdi:palette
      input:
        restore_last_scene:
          name: Återställ senaste scen
          default: false
          selector:
            boolean: {}
        input_text_last_scene:
          name: Input Text - Senaste scen
          description: Input Text som lagrar den senaste scenen som kan återställas.
          default: []
          selector:
            entity:
              domain:
              - input_text
              reorder: false
              multiple: false
    lux_sun:
      name: Lux & Sol
      description: Sensor för lux och inställningar för solens tider
      collapsed: true
      icon: mdi:white-balance-sunny
      input:
        lux_sensor:
          name: Luxsensor
          default: []
          selector:
            entity:
              domain:
              - sensor
              device_class:
              - illuminance
              reorder: false
              multiple: false
        lux_threshold:
          name: Luxgräns
          default: []
          selector:
            number:
              min: 0.0
              max: 3000.0
              step: 1.0
              unit_of_measurement: lx
              mode: slider
        use_sun_times:
          name: Använd soluppgång/solnedgång
          default: false
          selector:
            boolean: {}
        sunset_offset:
          name: Offset för solnedgång
          default: 00:00:00
          selector:
            time: {}
        sunrise_offset:
          name: Offset för soluppgång
          default: 00:00:00
          selector:
            time: {}
    circadian:
      name: Circadian-ljus
      description: Inställningar för circadian-lampor
      collapsed: true
      icon: mdi:theme-light-dark
      input:
        circadian_enabled:
          name: Aktivera Circadian
          default: false
          selector:
            boolean: {}
        circadian_lights:
          name: Circadian-lampor
          default: []
          selector:
            target:
              entity:
              - domain:
                - light
        update_interval:
          name: Circadian update interval (min)
          default: 15
          selector:
            number:
              min: 1.0
              max: 60.0
              step: 1.0
              unit_of_measurement: min
              mode: slider
        circadian_min_temp:
          name: Minimum färgtemperatur (K)
          default: 2700
          selector:
            number:
              min: 1500.0
              max: 6500.0
              step: 100.0
              unit_of_measurement: K
              mode: slider
        circadian_max_temp:
          name: Maximum färgtemperatur (K)
          default: 5000
          selector:
            number:
              min: 1500.0
              max: 6500.0
              step: 100.0
              unit_of_measurement: K
              mode: slider
        auto_off_circadian:
          name: Circadian-lampors varaktighet (minuter)
          default: []
          selector:
            number:
              min: 0.0
              max: 1200.0
              step: 1.0
              unit_of_measurement: min
              mode: box
    fixed_times:
      name: Fasta avstängningstider
      description: Automatisk avstängning för lampor eller smarta uttag
      collapsed: true
      icon: mdi:clock-outline
      input:
        fixed_off_time_1:
          name: Fast avstängningstid 1
          default: []
          selector:
            time: {}
        fixed_off_weekdays_1:
          name: Aktiva veckodagar (Fast tid 1)
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Måndag
                value: mon
              - label: Tisdag
                value: tue
              - label: Onsdag
                value: wed
              - label: Torsdag
                value: thu
              - label: Fredag
                value: fri
              - label: Lördag
                value: sat
              - label: Söndag
                value: sun
              sort: false
              custom_value: false
        fixed_off_time_2:
          name: Fast avstängningstid 2
          default: []
          selector:
            time: {}
        fixed_off_weekdays_2:
          name: Aktiva veckodagar (Fast tid 2)
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Måndag
                value: mon
              - label: Tisdag
                value: tue
              - label: Onsdag
                value: wed
              - label: Torsdag
                value: thu
              - label: Fredag
                value: fri
              - label: Lördag
                value: sat
              - label: Söndag
                value: sun
              sort: false
              custom_value: false
    failsafe:
      name: Arbetsdag & Failsafe
      description: Sensor och timers för failsafe
      collapsed: true
      icon: mdi:shield-alert-outline
      input:
        workday_sensor:
          name: Arbetsdagsensor
          default: []
          selector:
            entity:
              domain:
              - binary_sensor
              reorder: false
              multiple: false
        enable_failsafe:
          name: Aktivera failsafe
          default: true
          selector:
            boolean: {}
        failsafe_timer_main:
          name: Failsafe-timer huvudbelysning (minuter)
          default: []
          selector:
            number:
              min: 1.0
              max: 240.0
              step: 1.0
              unit_of_measurement: min
              mode: slider
        failsafe_timer_day:
          name: Failsafe-timer dag (minuter)
          default: []
          selector:
            number:
              min: 1.0
              max: 120.0
              step: 1.0
              unit_of_measurement: min
              mode: slider
        failsafe_timer_night:
          name: Failsafe-timer natt (minuter)
          default: []
          selector:
            number:
              min: 1.0
              max: 120.0
              step: 1.0
              unit_of_measurement: min
              mode: slider
        failsafe_timer_circadian:
          name: Failsafe-timer circadian-lampor (minuter)
          default: []
          selector:
            number:
              min: 1.0
              max: 120.0
              step: 1.0
              unit_of_measurement: min
              mode: slider
  source_url: https://github.com/razzietheman/Avancerad-blueprint-for-belysning/blob/main/Tand_slack_blueprint.yaml
trigger:
- platform: state
  entity_id: !input motion_sensors
  to: 'on'
  id: motion_on
- platform: state
  entity_id: !input motion_sensors
  from: 'off'
  to: 'on'
  id: motion_on
- platform: state
  entity_id: !input motion_sensors
  from: 'on'
  to: 'off'
  id: motion_off
- platform: state
  entity_id: !input optional_switches
  to: 'on'
  id: switch_on
- platform: state
  entity_id: !input optional_switches
  to: 'off'
  id: switch_off
- platform: sun
  event: sunrise
  offset: !input sunrise_offset
  id: sunrise_trigger
  enabled: !input use_sun_times
- platform: sun
  event: sunset
  offset: !input sunset_offset
  id: sunset_trigger
  enabled: !input use_sun_times
- platform: time
  at: !input fixed_off_time_1
  id: fixed_off_1
- platform: time
  at: !input fixed_off_time_2
  id: fixed_off_2
- platform: time_pattern
  minutes: 15
  id: circadian_update
  enabled: !input circadian_enabled
mode: restart
variables:
  use_persistent_notifications_var: !input use_persistent_notifications
  motion_sensors_var: !input motion_sensors
  main_lights_var: !input main_lights
  day_lights_var: !input day_lights
  brightness_day_var: !input brightness_day
  night_lights_var: !input night_lights
  brightness_night_var: !input brightness_night
  scene_day_var: !input scene_day
  off_scene_day_var: !input off_scene_day
  scene_night_var: !input scene_night
  off_scene_night_var: !input off_scene_night
  last_scene_entity: !input input_text_last_scene
  restore_last_scene_var: !input restore_last_scene
  lux_sensor_var: !input lux_sensor
  lux_threshold_var: !input lux_threshold
  use_sun_times_var: !input use_sun_times
  workday_sensor_var: !input workday_sensor
  auto_off_main_var: !input auto_off_main
  auto_off_day_var: !input auto_off_day
  auto_off_night_var: !input auto_off_night
  auto_off_circadian_var: !input auto_off_circadian
  fixed_off_weekdays_1_var: !input fixed_off_weekdays_1
  fixed_off_weekdays_2_var: !input fixed_off_weekdays_2
  day_start_var: !input day_start
  day_end_var: !input day_end
  night_start_var: !input night_start
  night_end_var: !input night_end
  active_weekdays_day_var: !input active_weekdays_day
  active_weekdays_night_var: !input active_weekdays_night
  enable_failsafe_var: !input enable_failsafe
  failsafe_timer_main_var: !input failsafe_timer_main
  failsafe_timer_day_var: !input failsafe_timer_day
  failsafe_timer_night_var: !input failsafe_timer_night
  circadian_enabled_var: !input circadian_enabled
  circadian_lights_var: !input circadian_lights
  circadian_min_temp_var: !input circadian_min_temp
  circadian_max_temp_var: !input circadian_max_temp
  failsafe_timer_circadian_var: !input failsafe_timer_circadian
action:
- choose:
  - conditions:
    - condition: or
      conditions:
      - condition: trigger
        id: motion_on
      - condition: trigger
        id: switch_on
    - condition: template
      value_template: '{{ (optional_switches | default([])) != [] or trigger.id ==
        ''motion_on'' }}'
    sequence:
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set lights = [] %} {% for var in [main_lights_var, day_lights_var,
            night_lights_var] %}\n  {% if var is string and var != '' %}\n    {% set
            lights = lights + [var] %}\n  {% elif var is mapping and var.entity_id
            is string %}\n    {% set lights = lights + [var.entity_id] %}\n  {% elif
            var is iterable %}\n    {% set lights = lights + var %}\n  {% endif %}\n{%
            endfor %} {{ lights | count > 0 }}\n"
        sequence:
        - service: scene.create
          data:
            scene_id: snapshot_before_on
            snapshot_entities: "{% set lights = [] %} {% for var in [main_lights_var,
              day_lights_var, night_lights_var] %}\n  {% if var is string and var
              != '' %}\n    {% set lights = lights + [var] %}\n  {% elif var is mapping
              and var.entity_id is string %}\n    {% set lights = lights + [var.entity_id]
              %}\n  {% elif var is iterable %}\n    {% set lights = lights + var %}\n
              \ {% endif %}\n{% endfor %} {{ lights | tojson }}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: "{% if day_start_var is defined and day_end_var is defined
            %}\n  {% set t = now().time() %}\n  {% set start = strptime(day_start_var,
            '%H:%M:%S').time() %}\n  {% set end = strptime(day_end_var, '%H:%M:%S').time()
            %}\n  {{ ((start <= end and start <= t <= end) or (start > end and (t
            >= start or t <= end))) }}\n{% else %}\n  false\n{% endif %}\n"
        sequence:
        - choose:
          - conditions:
            - condition: template
              value_template: "{{ scene_day_var | default([]) != [] and\n   (lux_sensor_var
                | default('') == '' or\n    states(lux_sensor_var) | float < lux_threshold_var
                | float) }}\n"
            sequence:
            - service: scene.turn_on
              target:
                entity_id: '{{ scene_day_var }}'
          - conditions:
            - condition: template
              value_template: "{{ day_lights_var | default('') != '' and \n   (lux_sensor_var
                | default('') == '' or \n    states(lux_sensor_var) | float < lux_threshold_var
                | float) }}\n"
            sequence:
            - service: light.turn_on
              target:
                entity_id: "{% if day_lights_var is string %}\n  {{ day_lights_var
                  }}\n{% elif day_lights_var is mapping %}\n  {{ day_lights_var.entity_id
                  }}\n{% elif day_lights_var is iterable %}\n  {{ day_lights_var |
                  join(',') }}\n{% endif %}\n"
              data:
                brightness: "{% if brightness_day_var != '' %}\n  {{ (brightness_day_var
                  | int * 255 / 100) | int }}\n{% else %}\n  255\n{% endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: "{% if night_start_var is defined and night_end_var is defined
            %}\n  {% set t = now().time() %}\n  {% set start = strptime(night_start_var,
            '%H:%M:%S').time() %}\n  {% set end = strptime(night_end_var, '%H:%M:%S').time()
            %}\n  {{ ((start <= end and start <= t <= end) or (start > end and (t
            >= start or t <= end))) }}\n{% else %}\n  false\n{% endif %}\n"
        sequence:
        - choose:
          - conditions:
            - condition: template
              value_template: "{{ scene_night_var | default([]) != [] and\n   (lux_sensor_var
                | default('') == '' or\n    states(lux_sensor_var) | float < lux_threshold_var
                | float) }}\n"
            sequence:
            - service: scene.turn_on
              target:
                entity_id: '{{ scene_night_var }}'
          - conditions:
            - condition: template
              value_template: "{{ night_lights_var | default('') != '' and \n   (lux_sensor_var
                | default('') == '' or \n    states(lux_sensor_var) | float < lux_threshold_var
                | float) }}\n"
            sequence:
            - service: light.turn_on
              target:
                entity_id: "{% if night_lights_var is string %}\n  {{ night_lights_var
                  }}\n{% elif night_lights_var is mapping %}\n  {{ night_lights_var.entity_id
                  }}\n{% elif night_lights_var is iterable %}\n  {{ night_lights_var
                  | join(',') }}\n{% endif %}\n"
              data:
                brightness: "{% if brightness_night_var != '' %}\n  {{ (brightness_night_var
                  | int * 255 / 100) | int }}\n{% else %}\n  255\n{% endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ day_lights_var | default([]) | select(''is_state'',''on'')
            | list | count > 0 }}

            '
        sequence:
        - service: input_text.set_value
          target:
            entity_id: input_text.last_scene_triggered
          data:
            value: '{{ scene_day_var }}'
      - conditions:
        - condition: template
          value_template: '{{ night_lights_var | default([]) | select(''is_state'',''on'')
            | list | count > 0 }}

            '
        sequence:
        - service: input_text.set_value
          target:
            entity_id: input_text.last_scene_triggered
          data:
            value: '{{ scene_night_var }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: "{% set t = now().time() %} {% set day_start = strptime(day_start_var,
              '%H:%M:%S').time() %} {% set day_end = strptime(day_end_var, '%H:%M:%S').time()
              %} {% set night_start = strptime(night_start_var, '%H:%M:%S').time()
              %} {% set night_end = strptime(night_end_var, '%H:%M:%S').time() %}
              {% if use_sun_times_var %}\n  {% if is_state('sun.sun','above_horizon')
              %}\n    {% set mode = 'Dagläge' %}\n  {% elif is_state('sun.sun','below_horizon')
              %}\n    {% set mode = 'Nattläge' %}\n  {% else %}\n    {% set mode =
              'Okänt läge' %}\n  {% endif %}\n{% else %}\n  {% if day_start <= day_end
              %}\n    {% set is_daytime = (t >= day_start and t <= day_end) %}\n  {%
              else %}\n    {% set is_daytime = (t >= day_start or t <= day_end) %}\n
              \ {% endif %}\n  {% if night_start <= night_end %}\n    {% set is_nighttime
              = (t >= night_start and t <= night_end) %}\n  {% else %}\n    {% set
              is_nighttime = (t >= night_start or t <= night_end) %}\n  {% endif %}\n
              \ {% if is_daytime %}\n    {% set mode = 'Dagläge' %}\n  {% elif is_nighttime
              %}\n    {% set mode = 'Nattläge' %}\n  {% else %}\n    {% set mode =
              'Okänt läge' %}\n  {% endif %}\n{% endif %} Belysning tänd via {{ 'rörelse'
              if trigger.id == 'motion_on' else 'switch' }} ({{ mode }}).\n"
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: "{% set t = now().time() %} {% set day_start = strptime(day_start_var,
              '%H:%M:%S').time() %} {% set day_end = strptime(day_end_var, '%H:%M:%S').time()
              %} {% set night_start = strptime(night_start_var, '%H:%M:%S').time()
              %} {% set night_end = strptime(night_end_var, '%H:%M:%S').time() %}
              {% if use_sun_times_var %}\n  {% if is_state('sun.sun','above_horizon')
              %}\n    {% set mode = 'Dagläge' %}\n  {% elif is_state('sun.sun','below_horizon')
              %}\n    {% set mode = 'Nattläge' %}\n  {% else %}\n    {% set mode =
              'Okänt läge' %}\n  {% endif %}\n{% else %}\n  {% if day_start <= day_end
              %}\n    {% set is_daytime = (t >= day_start and t <= day_end) %}\n  {%
              else %}\n    {% set is_daytime = (t >= day_start or t <= day_end) %}\n
              \ {% endif %}\n  {% if night_start <= night_end %}\n    {% set is_nighttime
              = (t >= night_start and t <= night_end) %}\n  {% else %}\n    {% set
              is_nighttime = (t >= night_start or t <= night_end) %}\n  {% endif %}\n
              \ {% if is_daytime %}\n    {% set mode = 'Dagläge' %}\n  {% elif is_nighttime
              %}\n    {% set mode = 'Nattläge' %}\n  {% else %}\n    {% set mode =
              'Okänt läge' %}\n  {% endif %}\n{% endif %} Belysning tänd via {{ 'rörelse'
              if trigger.id == 'motion_on' else 'switch' }} ({{ mode }}).\n"
- choose:
  - conditions:
    - condition: template
      value_template: "{% set lights = [] %} {% if main_lights_var is string and main_lights_var
        != '' %}\n  {% set lights = [main_lights_var] %}\n{% elif main_lights_var
        is mapping and main_lights_var.entity_id is string %}\n  {% set lights = [main_lights_var.entity_id]
        %}\n{% elif main_lights_var is iterable %}\n  {% set lights = main_lights_var
        | select('string') | list %}\n{% endif %} {{ lights | count > 0 }}\n"
    sequence:
    - delay:
        minutes: '{{ auto_off_main_var | default(0) | float }}'
    - service: light.turn_off
      target:
        entity_id: "{% set lights = [] %} {% if main_lights_var is string and main_lights_var
          != '' %}\n  {% set lights = [main_lights_var] %}\n{% elif main_lights_var
          is mapping and main_lights_var.entity_id is string %}\n  {% set lights =
          [main_lights_var.entity_id] %}\n{% elif main_lights_var is iterable %}\n
          \ {% set lights = main_lights_var | select('string') | list %}\n{% endif
          %} {{ lights | join(',') }}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Auto-off Main: Huvudlampor släckta.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Auto-off Main: Huvudlampor släckta.'
- choose:
  - conditions:
    - condition: template
      value_template: "{% if use_sun_times_var %}\n  {{ is_state('sun.sun','above_horizon')
        }}\n{% else %}\n  {% set t = now().time() %}\n  {% set day_start_time = strptime(day_start_var,
        '%H:%M:%S').time() %}\n  {% set day_end_time   = strptime(day_end_var, '%H:%M:%S').time()
        %}\n  {% if day_start_time <= day_end_time %}\n    {{ t >= day_start_time
        and t <= day_end_time }}\n  {% else %}\n    {{ t >= day_start_time or t <=
        day_end_time }}\n  {% endif %}\n{% endif %}\n"
    - condition: template
      value_template: "{{ (day_lights_var is string and day_lights_var != '') \n    or
        (day_lights_var is mapping and day_lights_var.entity_id is string) \n    or
        (day_lights_var is iterable and (day_lights_var | select('string') | list
        | count > 0))\n    or (off_scene_day_var is string and off_scene_day_var !=
        '') }}\n"
    sequence:
    - delay:
        minutes: '{{ auto_off_day_var | default(0) | float }}'
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set lights_on = [] %} {% if day_lights_var is string
            and day_lights_var != '' %}\n  {% set lights_on = [day_lights_var] %}\n{%
            elif day_lights_var is mapping and day_lights_var.entity_id is string
            %}\n  {% set lights_on = [day_lights_var.entity_id] %}\n{% elif day_lights_var
            is iterable %}\n  {% set lights_on = day_lights_var | select('string')
            | list %}\n{% endif %} {% set motion = expand(motion_sensors | default([]))
            | selectattr('state','eq','on') | list %} {{ lights_on | select('is_state','on')
            | list | count > 0 and motion | count == 0 }}\n"
        sequence:
        - service: light.turn_off
          target:
            entity_id: "{% set lights_on = [] %} {% if day_lights_var is string and
              day_lights_var != '' %}\n  {% set lights_on = [day_lights_var] %}\n{%
              elif day_lights_var is mapping and day_lights_var.entity_id is string
              %}\n  {% set lights_on = [day_lights_var.entity_id] %}\n{% elif day_lights_var
              is iterable %}\n  {% set lights_on = day_lights_var | select('string')
              | list %}\n{% endif %} {{ lights_on | join(',') }}\n"
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ use_persistent_notifications_var }}'
            sequence:
            - service: persistent_notification.create
              data:
                title: Belysningsautomation
                message: 'Auto-off Dag: Daglampor släckta.'
          - conditions: []
            sequence:
            - service: logbook.log
              data:
                name: Belysningsautomation
                message: 'Auto-off Dag: Daglampor släckta.'
      - conditions:
        - condition: template
          value_template: "{{ off_scene_day_var is string and off_scene_day_var !=
            '' and\n   expand(motion_sensors | default([])) | selectattr('state','eq','on')
            | list | count == 0 }}\n"
        sequence:
        - service: scene.turn_on
          target:
            entity_id: '{{ off_scene_day_var }}'
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ use_persistent_notifications_var }}'
            sequence:
            - service: persistent_notification.create
              data:
                title: Belysningsautomation
                message: 'Auto-off Dag: Dag scen återställd.'
          - conditions: []
            sequence:
            - service: logbook.log
              data:
                name: Belysningsautomation
                message: 'Auto-off Dag: Dag scen återställd.'
- choose:
  - conditions:
    - condition: template
      value_template: "{% if use_sun_times_var %}\n  {{ is_state('sun.sun','below_horizon')
        }}\n{% else %}\n  {% set t = now().time() %}\n  {% set night_start_time =
        strptime(night_start_var, '%H:%M:%S').time() %}\n  {% set night_end_time   =
        strptime(night_end_var, '%H:%M:%S').time() %}\n  {% if night_start_time <=
        night_end_time %}\n    {{ t >= night_start_time and t <= night_end_time }}\n
        \ {% else %}\n    {{ t >= night_start_time or t <= night_end_time }}\n  {%
        endif %}\n{% endif %}\n"
    - condition: template
      value_template: "{{ (night_lights_var is string and night_lights_var != '')
        \n    or (night_lights_var is mapping and night_lights_var.entity_id is string)
        \n    or (night_lights_var is iterable and (night_lights_var | select('string')
        | list | count > 0))\n    or (off_scene_night_var is string and off_scene_night_var
        != '') }}\n"
    sequence:
    - delay:
        minutes: '{{ auto_off_night_var | default(0) | float }}'
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set lights_on = [] %} {% if night_lights_var is string
            and night_lights_var != '' %}\n  {% set lights_on = [night_lights_var]
            %}\n{% elif night_lights_var is mapping and night_lights_var.entity_id
            is string %}\n  {% set lights_on = [night_lights_var.entity_id] %}\n{%
            elif night_lights_var is iterable %}\n  {% set lights_on = night_lights_var
            | select('string') | list %}\n{% endif %} {% set motion = expand(motion_sensors
            | default([])) | selectattr('state','eq','on') | list %} {{ lights_on
            | select('is_state','on') | list | count > 0 and motion | count == 0 }}\n"
        sequence:
        - service: light.turn_off
          target:
            entity_id: "{% set lights_on = [] %} {% if night_lights_var is string
              and night_lights_var != '' %}\n  {% set lights_on = [night_lights_var]
              %}\n{% elif night_lights_var is mapping and night_lights_var.entity_id
              is string %}\n  {% set lights_on = [night_lights_var.entity_id] %}\n{%
              elif night_lights_var is iterable %}\n  {% set lights_on = night_lights_var
              | select('string') | list %}\n{% endif %} {{ lights_on | join(',') }}\n"
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ use_persistent_notifications_var }}'
            sequence:
            - service: persistent_notification.create
              data:
                title: Belysningsautomation
                message: 'Auto-off Natt: Nattlampor släckta.'
          - conditions: []
            sequence:
            - service: logbook.log
              data:
                name: Belysningsautomation
                message: 'Auto-off Natt: Nattlampor släckta.'
      - conditions:
        - condition: template
          value_template: "{{ off_scene_night_var is string and off_scene_night_var
            != '' and\n   expand(motion_sensors | default([])) | selectattr('state','eq','on')
            | list | count == 0 }}\n"
        sequence:
        - service: scene.turn_on
          target:
            entity_id: '{{ off_scene_night_var }}'
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ use_persistent_notifications_var }}'
            sequence:
            - service: persistent_notification.create
              data:
                title: Belysningsautomation
                message: 'Auto-off Natt: Off Scene Natt aktiverad.'
          - conditions: []
            sequence:
            - service: logbook.log
              data:
                name: Belysningsautomation
                message: 'Auto-off Natt: Off Scene Natt aktiverad.'
- choose:
  - conditions:
    - condition: template
      value_template: "{% set lights = [] %} {% if circadian_lights_var is string
        and circadian_lights_var != '' %}\n  {% set lights = [circadian_lights_var]
        %}\n{% elif circadian_lights_var is mapping and circadian_lights_var.entity_id
        is string %}\n  {% set lights = [circadian_lights_var.entity_id] %}\n{% elif
        circadian_lights_var is iterable %}\n  {% set lights = circadian_lights_var
        | select('string') | list %}\n{% endif %} {{ lights | count > 0 }}\n"
    sequence:
    - delay:
        minutes: '{{ auto_off_circadian_var | default(0) | float }}'
    - service: light.turn_off
      target:
        entity_id: "{% set lights = [] %} {% if circadian_lights_var is string and
          circadian_lights_var != '' %}\n  {% set lights = [circadian_lights_var]
          %}\n{% elif circadian_lights_var is mapping and circadian_lights_var.entity_id
          is string %}\n  {% set lights = [circadian_lights_var.entity_id] %}\n{%
          elif circadian_lights_var is iterable %}\n  {% set lights = circadian_lights_var
          | select('string') | list %}\n{% endif %} {{ lights | join(',') }}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Auto-off Circadian: Circadian-lampor släckta.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Auto-off Circadian: Circadian-lampor släckta.'
- choose:
  - conditions:
    - condition: trigger
      id: fixed_off_1
    - condition: template
      value_template: '{{ now().strftime(''%a'').lower() in fixed_off_weekdays_1_var
        }}'
    sequence:
    - service: light.turn_off
      target:
        entity_id: "{% set entities = [] %} {% for var in [main_lights_var, day_lights_var,
          night_lights_var, optional_switches_var] %}\n  {% if var | default('') !=
          '' %}\n    {% if var is string %}\n      {% set entities = entities + [var]
          %}\n    {% elif var is mapping %}\n      {% set entities = entities + [var.entity_id]
          %}\n    {% elif var is iterable %}\n      {% set entities = entities + var
          %}\n    {% endif %}\n  {% endif %}\n{% endfor %} {{ entities | join(',')
          }}\n"
- choose:
  - conditions:
    - condition: trigger
      id: fixed_off_2
    - condition: template
      value_template: '{{ now().strftime(''%a'').lower() in fixed_off_weekdays_2_var
        }}'
    sequence:
    - service: light.turn_off
      target:
        entity_id: "{% set entities = [] %} {% for var in [main_lights_var, day_lights_var,
          night_lights_var, optional_switches_var] %}\n  {% if var | default('') !=
          '' %}\n    {% if var is string %}\n      {% set entities = entities + [var]
          %}\n    {% elif var is mapping %}\n      {% set entities = entities + [var.entity_id]
          %}\n    {% elif var is iterable %}\n      {% set entities = entities + var
          %}\n    {% endif %}\n  {% endif %}\n{% endfor %} {{ entities | join(',')
          }}\n"
- choose:
  - conditions:
    - condition: trigger
      id: motion_on
    - condition: template
      value_template: '{% set circadian_enabled_var = circadian_enabled_var | default(false)
        %} {% set circadian_lights_var = circadian_lights_var | default([]) %} {{
        circadian_enabled_var and circadian_lights_var != [] }}

        '
    sequence:
    - service: light.turn_on
      target:
        entity_id: "{% if circadian_lights_var is string %}\n  {{ circadian_lights_var
          }}\n{% elif circadian_lights_var is mapping %}\n  {{ circadian_lights_var.entity_id
          }}\n{% elif circadian_lights_var is iterable %}\n  {{ circadian_lights_var
          | join(',') }}\n{% endif %}\n"
      data:
        color_temp_kelvin: '{{ circadian_temp_var | default(2700) }}'
        brightness: '{{ circadian_brightness_var | default(255) }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{% set use_persistent_notifications_var = use_persistent_notifications_var
            | default(false) %} {{ use_persistent_notifications_var }}

            '
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Circadian Lampor: Justerad automatiskt.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Circadian Lampor: Justerad automatiskt.'
- choose:
  - conditions:
    - condition: trigger
      id: circadian_update
    - condition: template
      value_template: '{% set circadian_enabled_var = circadian_enabled_var | default(false)
        %} {% set circadian_lights_var = circadian_lights_var | default([]) %} {{
        circadian_enabled_var and circadian_lights_var != [] }}

        '
    sequence:
    - service: light.turn_on
      target:
        entity_id: "{% if circadian_lights_var is string %}\n  {{ circadian_lights_var
          }}\n{% elif circadian_lights_var is mapping %}\n  {{ circadian_lights_var.entity_id
          }}\n{% elif circadian_lights_var is iterable %}\n  {{ circadian_lights_var
          | join(',') }}\n{% endif %}\n"
      data:
        color_temp_kelvin: '{{ circadian_temp_var | default(2700) }}'
        brightness: '{{ circadian_brightness_var | default(255) }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{% set use_persistent_notifications_var = use_persistent_notifications_var
            | default(false) %} {{ use_persistent_notifications_var }}

            '
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Circadian Update: Justerad automatiskt via time_pattern.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Circadian Update: Justerad automatiskt via time_pattern.'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and main_lights_var | default('''')
        != '''' }}'
    - condition: template
      value_template: "{% set lights = [] %} {% if main_lights_var is string %}\n
        \ {% set lights = [main_lights_var] %}\n{% elif main_lights_var is mapping
        %}\n  {% set lights = [main_lights_var.entity_id] %}\n{% elif main_lights_var
        is iterable %}\n  {% set lights = main_lights_var %}\n{% endif %} {{ lights
        | select('is_state','on') | list | count > 0 }}\n"
    - condition: template
      value_template: "{{ expand(motion_sensors | default([])) \n    | selectattr('state','eq','on')
        \n    | list | count == 0 }}\n"
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_main_var | default(0) | float }}'
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set lights = [] %} {% if main_lights_var is string %}\n
            \ {% set lights = [main_lights_var] %}\n{% elif main_lights_var is mapping
            %}\n  {% set lights = [main_lights_var.entity_id] %}\n{% elif main_lights_var
            is iterable %}\n  {% set lights = main_lights_var %}\n{% endif %} {{ lights
            | select('is_state','on') | list | count > 0 }}\n"
        sequence:
        - service: light.turn_off
          target:
            entity_id: "{% if main_lights_var is string %}\n  {{ main_lights_var }}\n{%
              elif main_lights_var is mapping %}\n  {{ main_lights_var.entity_id }}\n{%
              elif main_lights_var is iterable %}\n  {{ main_lights_var | join(',')
              }}\n{% endif %}\n"
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ use_persistent_notifications_var }}'
            sequence:
            - service: persistent_notification.create
              data:
                title: Belysningsautomation
                message: 'Failsafe Main: Huvudlampor släckta automatiskt (ingen rörelse).'
          - conditions: []
            sequence:
            - service: logbook.log
              data:
                name: Belysningsautomation
                message: 'Failsafe Main: Huvudlampor släckta automatiskt (ingen rörelse).'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var }}'
    - condition: template
      value_template: "{% set lights = [] %} {% if day_lights_var is string %}\n  {%
        set lights = [day_lights_var] %}\n{% elif day_lights_var is mapping %}\n  {%
        set lights = [day_lights_var.entity_id] %}\n{% elif day_lights_var is iterable
        %}\n  {% set lights = day_lights_var %}\n{% endif %} {{ lights | select('is_state','on')
        | list | count > 0 }}\n"
    - condition: template
      value_template: '{% set t = now().time() %} {% set start = strptime(day_start_var,
        ''%H:%M:%S'').time() %} {% set end   = strptime(day_end_var, ''%H:%M:%S'').time()
        %} {{ t >= start and t <= end }}

        '
    - condition: template
      value_template: '{{ expand(motion_sensors | default([])) | selectattr(''state'',''eq'',''on'')
        | list | count == 0 }}

        '
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_day_var | default(0) | float }}'
    - service: light.turn_off
      target:
        entity_id: "{% if day_lights_var is string %}\n  {{ day_lights_var }}\n{%
          elif day_lights_var is mapping %}\n  {{ day_lights_var.entity_id }}\n{%
          elif day_lights_var is iterable %}\n  {{ day_lights_var | join(',') }}\n{%
          endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Failsafe Dag: Daglampor släckta automatiskt.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Failsafe Dag: Daglampor släckta automatiskt.'
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and off_scene_day_var is string and
        off_scene_day_var != '''' }}'
    - condition: template
      value_template: '{{ expand(motion_sensors | default([])) | selectattr(''state'',''eq'',''on'')
        | list | count == 0 }}

        '
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_day_var | default(0) | float }}'
    - service: scene.turn_on
      target:
        entity_id: '{{ off_scene_day_var }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Failsafe Dag: Off-scen Aktiverad.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Failsafe Dag: Off-scen Aktiverad.'
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and restore_last_scene_var }}'
    - condition: template
      value_template: '{{ states(last_scene_entity) | default('''') != '''' }}'
    - condition: template
      value_template: '{{ expand(motion_sensors | default([])) | selectattr(''state'',''eq'',''on'')
        | list | count == 0 }}

        '
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_day_var | default(0) | float }}'
    - service: scene.turn_on
      target:
        entity_id: '{{ states(last_scene_entity) }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Failsafe Dag: Senaste scen återställd.'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Failsafe Dag: Senaste scen återställd.'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var }}'
    - condition: template
      value_template: "{% set lights = [] %} {% if night_lights_var is string %}\n
        \ {% set lights = [night_lights_var] %}\n{% elif night_lights_var is mapping
        %}\n  {% set lights = [night_lights_var.entity_id] %}\n{% elif night_lights_var
        is iterable %}\n  {% set lights = night_lights_var %}\n{% endif %} {{ lights
        | select('is_state','on') | list | count > 0 }}\n"
    - condition: template
      value_template: "{% set t = now().time() %} {% set start = strptime(night_start_var,
        '%H:%M:%S').time() %} {% set end   = strptime(night_end_var, '%H:%M:%S').time()
        %} {% if start <= end %}\n  {{ t >= start and t <= end }}\n{% else %}\n  {{
        t >= start or t <= end }}\n{% endif %}\n"
    - condition: template
      value_template: '{{ expand(motion_sensors | default([])) | selectattr(''state'',''eq'',''on'')
        | list | count == 0 }}

        '
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_night_var | default(0) | float }}'
    - service: light.turn_off
      target:
        entity_id: "{% if night_lights_var is string %}\n  {{ night_lights_var }}\n{%
          elif night_lights_var is mapping %}\n  {{ night_lights_var.entity_id }}\n{%
          elif night_lights_var is iterable %}\n  {{ night_lights_var | join(',')
          }}\n{% endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Failsafe Natt: Nattlampor släckta automatiskt (ingen rörelse).'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Failsafe Natt: Nattlampor släckta automatiskt (ingen rörelse).'
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and off_scene_night_var is string and
        off_scene_night_var != '''' }}'
    - condition: template
      value_template: '{{ expand(motion_sensors | default([])) | selectattr(''state'',''eq'',''on'')
        | list | count == 0 }}

        '
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_night_var | default(0) | float }}'
    - service: scene.turn_on
      target:
        entity_id: '{{ off_scene_night_var }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Failsafe Natt: Off-scen aktiverad (ingen rörelse).'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Failsafe Natt: Off-scen aktiverad (ingen rörelse).'
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and restore_last_scene_var }}'
    - condition: template
      value_template: '{{ states(last_scene_entity) | default('''') != '''' }}'
    - condition: template
      value_template: '{{ expand(motion_sensors | default([])) | selectattr(''state'',''eq'',''on'')
        | list | count == 0 }}

        '
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_night_var | default(0) | float }}'
    - service: scene.turn_on
      target:
        entity_id: '{{ states(last_scene_entity) }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ use_persistent_notifications_var }}'
        sequence:
        - service: persistent_notification.create
          data:
            title: Belysningsautomation
            message: 'Failsafe Natt: Senaste scen återställd (ingen rörelse).'
      - conditions: []
        sequence:
        - service: logbook.log
          data:
            name: Belysningsautomation
            message: 'Failsafe Natt: Senaste scen återställd (ingen rörelse).'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and circadian_lights_var | default('''')
        != '''' }}'
    - condition: template
      value_template: "{% set lights = [] %} {% if circadian_lights_var is string
        %}\n  {% set lights = [circadian_lights_var] %}\n{% elif circadian_lights_var
        is mapping %}\n  {% set lights = [circadian_lights_var.entity_id] %}\n{% elif
        circadian_lights_var is iterable %}\n  {% set lights = circadian_lights_var
        %}\n{% endif %} {{ lights | select('is_state','on') | list | count > 0 }}\n"
    sequence:
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set lights = [] %} {% if circadian_lights_var is string
            %}\n  {% set lights = [circadian_lights_var] %}\n{% elif circadian_lights_var
            is mapping %}\n  {% set lights = [circadian_lights_var.entity_id] %}\n{%
            elif circadian_lights_var is iterable %}\n  {% set lights = circadian_lights_var
            %}\n{% endif %} {{ lights | select('is_state','on') | list | count > 0
            }}\n"
        sequence:
        - delay:
            minutes: '{{ failsafe_timer_circadian_var | default(0) | float }}'
        - service: light.turn_off
          target:
            entity_id: "{% if circadian_lights_var is string %}\n  {{ circadian_lights_var
              }}\n{% elif circadian_lights_var is mapping %}\n  {{ circadian_lights_var.entity_id
              }}\n{% elif circadian_lights_var is iterable %}\n  {{ circadian_lights_var
              | join(',') }}\n{% endif %}\n"
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ use_persistent_notifications_var }}'
            sequence:
            - service: persistent_notification.create
              data:
                title: Belysningsautomation
                message: 'Failsafe Circadian lampor: Circadian lampor släckta automatiskt.'
          - conditions: []
            sequence:
            - service: logbook.log
              data:
                name: Belysningsautomation
                message: 'Failsafe Circadian lampor: Circadian lampor släckta automatiskt.'
